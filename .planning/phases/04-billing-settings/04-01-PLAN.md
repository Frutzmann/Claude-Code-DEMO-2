---
phase: 04-billing-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/006_billing.sql
  - src/types/database.ts
  - src/lib/stripe/server.ts
  - src/lib/billing/plans.ts
  - package.json
autonomous: true
user_setup:
  - service: stripe
    why: "Payment processing for subscriptions"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret (after creating endpoint)"
      - name: STRIPE_PRICE_PRO
        source: "Stripe Dashboard -> Products -> Pro plan -> Price ID (price_xxx)"
      - name: STRIPE_PRICE_AGENCY
        source: "Stripe Dashboard -> Products -> Agency plan -> Price ID (price_xxx)"
    dashboard_config:
      - task: "Create Pro product ($19/month, 50 generations)"
        location: "Stripe Dashboard -> Products -> Add product"
      - task: "Create Agency product ($49/month, 200 generations)"
        location: "Stripe Dashboard -> Products -> Add product"

must_haves:
  truths:
    - "Billing tables exist in database (customers, products, prices, subscriptions)"
    - "Stripe SDK is installed and configured"
    - "Plan definitions map price IDs to quotas"
  artifacts:
    - path: "supabase/migrations/006_billing.sql"
      provides: "Billing database schema"
      contains: "CREATE TABLE customers"
    - path: "src/lib/stripe/server.ts"
      provides: "Stripe client singleton"
      exports: ["stripe"]
    - path: "src/lib/billing/plans.ts"
      provides: "Plan configuration with quotas"
      exports: ["PLANS", "getPlanByPriceId", "getPlanQuota"]
    - path: "src/types/database.ts"
      provides: "TypeScript types for billing tables"
      contains: "subscriptions"
  key_links:
    - from: "src/lib/billing/plans.ts"
      to: "STRIPE_PRICE_PRO, STRIPE_PRICE_AGENCY"
      via: "process.env"
      pattern: "process\\.env\\.STRIPE_PRICE"
---

<objective>
Set up billing infrastructure: database tables for Stripe data, Stripe SDK, and plan definitions.

Purpose: This is the foundation for subscription billing. Without the database schema and Stripe client, webhook handling and checkout cannot work.

Output: Migration file for billing tables, Stripe client, plan configuration with quota mappings.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-billing-settings/04-RESEARCH.md

@src/types/database.ts
@src/lib/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and add shadcn components</name>
  <files>package.json</files>
  <action>
Install the stripe npm package and add new shadcn/ui components needed for settings:

```bash
npm install stripe
npx shadcn@latest add separator tabs radio-group alert-dialog
```

Verify installation succeeds and types are available.
  </action>
  <verify>
Run `npm ls stripe` to confirm stripe is installed.
Run `ls src/components/ui/` to verify separator.tsx, tabs.tsx, radio-group.tsx, alert-dialog.tsx exist.
  </verify>
  <done>
stripe package installed, 4 new shadcn components added to src/components/ui/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create billing database schema and TypeScript types</name>
  <files>
supabase/migrations/006_billing.sql
src/types/database.ts
  </files>
  <action>
Create `supabase/migrations/006_billing.sql` with 4 tables per RESEARCH.md:

1. **customers** - Links Supabase user to Stripe customer ID
   - `id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY`
   - `stripe_customer_id TEXT UNIQUE`
   - RLS enabled, no user SELECT policy (service role only)

2. **products** - Synced from Stripe
   - `id TEXT PRIMARY KEY` (Stripe product ID: prod_xxx)
   - `active BOOLEAN`, `name TEXT`, `description TEXT`, `image TEXT`, `metadata JSONB`
   - RLS: public read-only

3. **prices** - Synced from Stripe
   - `id TEXT PRIMARY KEY` (Stripe price ID: price_xxx)
   - `product_id TEXT REFERENCES products(id)`
   - `active BOOLEAN`, `description TEXT`, `unit_amount BIGINT`, `currency TEXT`
   - `type pricing_type`, `interval pricing_plan_interval`, `interval_count INTEGER`, `trial_period_days INTEGER`
   - `metadata JSONB`
   - Create ENUMs: `pricing_type` (one_time, recurring), `pricing_plan_interval` (day, week, month, year)
   - RLS: public read-only

4. **subscriptions** - User's active subscription
   - `id TEXT PRIMARY KEY` (Stripe subscription ID: sub_xxx)
   - `user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL`
   - `status subscription_status` ENUM (trialing, active, canceled, incomplete, incomplete_expired, past_due, unpaid, paused)
   - `metadata JSONB`, `price_id TEXT REFERENCES prices(id)`, `quantity INTEGER`
   - `cancel_at_period_end BOOLEAN`, `created TIMESTAMPTZ`, `current_period_start TIMESTAMPTZ NOT NULL`, `current_period_end TIMESTAMPTZ NOT NULL`
   - `ended_at TIMESTAMPTZ`, `cancel_at TIMESTAMPTZ`, `canceled_at TIMESTAMPTZ`, `trial_start TIMESTAMPTZ`, `trial_end TIMESTAMPTZ`
   - RLS: Users can view own subscription
   - Indexes: `subscriptions_user_status_idx`, `subscriptions_price_idx`

Then update `src/types/database.ts`:
- Add all 4 tables to the Database interface
- Add type aliases: Customer, Product, Price, Subscription, SubscriptionStatus
- Add the enum types for pricing_type, pricing_plan_interval, subscription_status
  </action>
  <verify>
Run `cat supabase/migrations/006_billing.sql | head -50` to verify CREATE TABLE customers exists.
Run `grep -c "subscriptions:" src/types/database.ts` to verify subscriptions table is in types.
  </verify>
  <done>
006_billing.sql contains 4 tables (customers, products, prices, subscriptions) with proper RLS.
database.ts includes all billing table types and type aliases.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Stripe client and plan configuration</name>
  <files>
src/lib/stripe/server.ts
src/lib/billing/plans.ts
  </files>
  <action>
Create `src/lib/stripe/server.ts`:
- Export Stripe instance configured with STRIPE_SECRET_KEY
- Use stripe SDK version ^17.x API
- Add TypeScript strict typing

```typescript
import Stripe from 'stripe'

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-02-31.acacia', // Use latest API version
  typescript: true,
})
```

Create `src/lib/billing/plans.ts`:
- Define PLANS object with free, pro, agency tiers
- Each plan: name, quota, priceId (null for free), priceMonthly, features array
- Export `getPlanByPriceId(priceId: string | null): PlanId` - maps price ID to plan
- Export `getPlanQuota(planId: PlanId): number` - returns quota for plan
- Export `PlanId` type

Plan quotas:
- free: 5 generations/month, priceId: null
- pro: 50 generations/month, priceId: process.env.STRIPE_PRICE_PRO
- agency: 200 generations/month, priceId: process.env.STRIPE_PRICE_AGENCY

Note: Use `process.env.STRIPE_PRICE_PRO!` and `process.env.STRIPE_PRICE_AGENCY!` with non-null assertion since these are required for paid plans to work.
  </action>
  <verify>
Run `npx tsc --noEmit src/lib/stripe/server.ts src/lib/billing/plans.ts` to verify no type errors.
Run `grep "getPlanByPriceId" src/lib/billing/plans.ts` to confirm function exists.
  </verify>
  <done>
src/lib/stripe/server.ts exports stripe client.
src/lib/billing/plans.ts exports PLANS, getPlanByPriceId, getPlanQuota, PlanId.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm ls stripe` shows stripe installed
2. `ls src/components/ui/separator.tsx` exists
3. `cat supabase/migrations/006_billing.sql` shows 4 CREATE TABLE statements
4. `grep "subscriptions:" src/types/database.ts` finds the table
5. `npx tsc --noEmit` passes without errors
</verification>

<success_criteria>
- stripe package is installed
- 4 new shadcn components exist (separator, tabs, radio-group, alert-dialog)
- 006_billing.sql migration file created with customers, products, prices, subscriptions tables
- database.ts updated with billing table types
- src/lib/stripe/server.ts exports configured Stripe client
- src/lib/billing/plans.ts exports plan configuration with quota lookup functions
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-settings/04-01-SUMMARY.md`
</output>
