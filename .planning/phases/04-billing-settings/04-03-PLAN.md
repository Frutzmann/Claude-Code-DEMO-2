---
phase: 04-billing-settings
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/(dashboard)/settings/page.tsx
  - src/app/(dashboard)/settings/client.tsx
  - src/components/settings/profile-form.tsx
  - src/components/settings/plan-display.tsx
  - src/components/settings/portal-button.tsx
  - src/actions/settings.ts
  - src/components/sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can view their profile information (name, email)"
    - "User can edit their display name"
    - "User sees current plan and usage (X/Y generations)"
    - "User can upgrade from Free to Pro/Agency via Stripe Checkout"
    - "Paid user can access Stripe Customer Portal"
    - "Admin sees 'Admin - Unlimited' badge instead of quota"
    - "Admin does not see upgrade CTAs"
  artifacts:
    - path: "src/app/(dashboard)/settings/page.tsx"
      provides: "Settings page server component"
      min_lines: 30
    - path: "src/app/(dashboard)/settings/client.tsx"
      provides: "Settings page client component with tabs"
      min_lines: 50
    - path: "src/components/settings/profile-form.tsx"
      provides: "Profile name editor form"
      min_lines: 40
    - path: "src/components/settings/plan-display.tsx"
      provides: "Current plan and usage display"
      min_lines: 50
    - path: "src/actions/settings.ts"
      provides: "Update profile action"
      exports: ["updateProfile"]
  key_links:
    - from: "src/app/(dashboard)/settings/page.tsx"
      to: "getGenerationQuota"
      via: "server action import"
      pattern: "getGenerationQuota"
    - from: "src/components/settings/plan-display.tsx"
      to: "createCheckoutSession"
      via: "upgrade button onClick"
      pattern: "createCheckoutSession"
    - from: "src/components/settings/portal-button.tsx"
      to: "createPortalSession"
      via: "button onClick"
      pattern: "createPortalSession"
---

<objective>
Build the Settings page with profile management, plan display, and subscription controls.

Purpose: Users need a place to see their account info, current plan usage, and upgrade/manage their subscription. This completes the billing flow from the user's perspective.

Output: Settings page with Profile and Billing tabs, working upgrade buttons and portal access.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-billing-settings/04-RESEARCH.md

@src/actions/billing.ts
@src/actions/generations.ts
@src/lib/billing/plans.ts
@src/components/sidebar.tsx
@src/app/(dashboard)/portraits/page.tsx
@src/app/(dashboard)/portraits/client.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings server action and page</name>
  <files>
src/actions/settings.ts
src/app/(dashboard)/settings/page.tsx
src/app/(dashboard)/settings/client.tsx
  </files>
  <action>
Create `src/actions/settings.ts`:
- "use server" directive
- `updateProfile({ fullName: string })`:
  - Get authenticated user
  - Validate fullName (1-100 chars)
  - Update profiles table: `full_name = fullName`
  - Return { success: true } or { error: string }

Create `src/app/(dashboard)/settings/page.tsx` (server component):
- Fetch user, profile, quota, and subscription data in parallel
- Get quota via getGenerationQuota()
- Query subscriptions table with prices and products joins for paid users
- Pass all data to SettingsClient component
- Follow existing pattern from portraits/page.tsx (server fetches, client renders)

Create `src/app/(dashboard)/settings/client.tsx`:
- "use client" directive
- Use Tabs component with two tabs: Profile, Billing
- Profile tab: ProfileForm component
- Billing tab: PlanDisplay and PortalButton components
- Handle URL params: show toast on ?success=true or ?canceled=true (checkout result)
- Props interface matching what page.tsx provides

Use existing patterns:
- Card components for sections
- Tailwind spacing and layout matching dashboard style
- Dark theme compatible
  </action>
  <verify>
Run `ls src/app/\\(dashboard\\)/settings/` to confirm page.tsx and client.tsx exist.
Run `grep "updateProfile" src/actions/settings.ts` to confirm action exists.
  </verify>
  <done>
Settings page loads profile and billing data.
Client renders with tabs for Profile and Billing.
updateProfile action updates display name.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create settings components</name>
  <files>
src/components/settings/profile-form.tsx
src/components/settings/plan-display.tsx
src/components/settings/portal-button.tsx
  </files>
  <action>
Create `src/components/settings/profile-form.tsx`:
- "use client" directive
- Use react-hook-form with zod validation (existing pattern)
- Form fields: email (disabled, shown for info), fullName (editable)
- Submit calls updateProfile action
- Use Card, CardHeader, CardContent, CardTitle, CardDescription
- Show loading state with Loader2 icon
- Toast success/error via sonner

Create `src/components/settings/plan-display.tsx`:
- "use client" directive
- Props: plan, used, limit, periodEnd, isAdmin
- If isAdmin: show Crown icon + "Admin - Unlimited" badge, no upgrade CTAs
- Else: show plan name, usage progress bar, period end info
- If over quota: show destructive message "You've reached your monthly limit"
- Upgrade buttons call createCheckoutSession with appropriate priceId
- For free users: show "Upgrade to Pro" and "Agency" buttons
- For pro users: show "Upgrade to Agency" button
- Use Progress component for usage bar
- Use formatDistanceToNow from date-fns for period end

Create `src/components/settings/portal-button.tsx`:
- "use client" directive
- Props: hasSubscription (only show if true)
- Button calls createPortalSession
- Show loading state with Loader2
- ExternalLink icon to indicate external redirect
  </action>
  <verify>
Run `ls src/components/settings/` to confirm all 3 components exist.
Run `grep "isAdmin" src/components/settings/plan-display.tsx` to confirm admin check.
  </verify>
  <done>
ProfileForm allows editing display name.
PlanDisplay shows usage with admin-aware rendering.
PortalButton opens Stripe Customer Portal for paid users.
  </done>
</task>

<task type="auto">
  <name>Task 3: Enable Settings in sidebar</name>
  <files>src/components/sidebar.tsx</files>
  <action>
Update `src/components/sidebar.tsx`:
- Find the Settings nav item (should have disabled: true or 'Soon' badge)
- Remove the disabled state and 'Soon' badge
- Ensure href points to "/settings"
- Verify the Settings icon is present (should be lucide-react Settings icon)

This follows the pattern established in Phase 3 where disabled items become active once their feature is built.
  </action>
  <verify>
Run `grep -A2 "Settings" src/components/sidebar.tsx` to see the nav item.
Confirm no 'disabled' or 'Soon' in the Settings item config.
  </verify>
  <done>
Settings link is active in sidebar navigation.
Users can navigate to /settings from dashboard.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify settings page and billing flow</name>
  <what-built>
Complete settings page with profile editing, plan display, and subscription management.
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/settings
3. Verify Profile tab:
   - Email is shown (disabled)
   - Display name is editable
   - Save Changes updates the name (check toast)
4. Verify Billing tab:
   - Free user: shows "Free Plan", usage bar (X/5), upgrade buttons
   - Usage bar shows correct count of generations this month
   - "Upgrade to Pro" button exists
5. (If admin user) Verify:
   - Shows "Admin - Unlimited" with Crown icon
   - No upgrade buttons visible
6. Click sidebar Settings link - should navigate correctly

Note: Full Stripe checkout testing requires env vars. The UI components should render correctly even without Stripe configured.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Settings page accessible at /settings
2. Profile form updates display name
3. Plan display shows correct plan and usage
4. Admin sees unlimited badge (if testing with admin email)
5. Sidebar Settings link is active
6. `npx tsc --noEmit` passes
</verification>

<success_criteria>
- User can view profile info (name, email) on settings page
- User can edit display name and see success toast
- User sees current plan name and usage (X/Y generations)
- User sees when quota resets (billing period end or month end)
- Free user sees upgrade buttons for Pro and Agency
- Pro user sees upgrade button for Agency only
- Paid user sees "Manage Subscription" button opening portal
- Admin user sees "Admin - Unlimited" with no upgrade CTAs
- Settings link is enabled in sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/04-billing-settings/04-03-SUMMARY.md`
</output>
