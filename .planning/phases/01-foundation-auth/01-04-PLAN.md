---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/app/(onboarding)/layout.tsx
  - src/app/(onboarding)/onboarding/page.tsx
  - src/app/(onboarding)/welcome/page.tsx
  - src/components/onboarding/portrait-upload.tsx
  - src/components/onboarding/welcome-tutorial.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/dashboard/page.tsx
  - src/components/dashboard/sidebar.tsx
  - src/components/dashboard/user-nav.tsx
  - src/middleware.ts
  - src/actions/onboarding.ts
autonomous: false

must_haves:
  truths:
    - "New users are redirected to onboarding before accessing dashboard"
    - "User can upload a portrait image during onboarding"
    - "User sees welcome tutorial after portrait upload"
    - "User is redirected to dashboard after completing onboarding"
    - "Completed users cannot access onboarding pages"
    - "Dashboard shows empty state for new users"
  artifacts:
    - path: "src/app/(onboarding)/onboarding/page.tsx"
      provides: "Portrait upload page"
      contains: "PortraitUpload"
    - path: "src/app/(onboarding)/welcome/page.tsx"
      provides: "Welcome tutorial page"
      contains: "WelcomeTutorial"
    - path: "src/app/(dashboard)/dashboard/page.tsx"
      provides: "Main dashboard page"
      contains: "Dashboard"
    - path: "src/middleware.ts"
      provides: "Onboarding enforcement"
      contains: "onboarding_completed"
    - path: "src/components/onboarding/portrait-upload.tsx"
      provides: "Portrait upload with drag-drop"
      contains: "storage.from"
  key_links:
    - from: "src/middleware.ts"
      to: "profiles.onboarding_completed"
      via: "database query in middleware"
      pattern: "onboarding_completed"
    - from: "src/components/onboarding/portrait-upload.tsx"
      to: "supabase.storage"
      via: "file upload to portraits bucket"
      pattern: "storage.*upload"
    - from: "src/app/(onboarding)/onboarding/page.tsx"
      to: "src/app/(onboarding)/welcome/page.tsx"
      via: "redirect after upload"
      pattern: "redirect.*welcome"
---

<objective>
Build onboarding flow with portrait upload and welcome tutorial, plus basic dashboard shell with empty states.

Purpose: Force new users through onboarding before accessing the main app, establishing their first portrait.
Output: Working onboarding flow (portrait upload -> welcome tutorial -> dashboard), middleware enforcement, dashboard shell.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create onboarding flow pages and components</name>
  <files>
    src/app/(onboarding)/layout.tsx
    src/app/(onboarding)/onboarding/page.tsx
    src/app/(onboarding)/welcome/page.tsx
    src/components/onboarding/portrait-upload.tsx
    src/components/onboarding/welcome-tutorial.tsx
    src/actions/onboarding.ts
  </files>
  <action>
    1. Create `src/actions/onboarding.ts` with "use server" directive:

       a) `completeOnboarding()`:
          - Get current user from server Supabase client
          - Update profiles table: set onboarding_completed = true
          - Return { success: true } or { error: message }

    2. Create `src/components/onboarding/portrait-upload.tsx` ("use client"):
       - Props: userId (string), onComplete callback
       - State: uploading, dragActive, preview (File URL)
       - Implement drag-and-drop zone with visual feedback
       - Accept only image files (image/*)
       - Validate file size (max 5MB)
       - On valid file:
         a) Show preview
         b) Upload to Supabase Storage: `portraits/{userId}/{uuid}.{ext}`
         c) Get public URL
         d) Update profile: avatar_url = publicUrl
         e) Call onComplete callback
       - Show loading state during upload
       - Show error toast on failure
       - Styling: Large drop zone with dashed border, glass effect

    3. Create `src/components/onboarding/welcome-tutorial.tsx` ("use client"):
       - Props: onComplete callback
       - Display 3 steps explaining the workflow:
         1. "Upload your portrait" (done - check mark)
         2. "Add background images and keywords"
         3. "Get AI-generated thumbnails"
       - Include simple illustrations or icons for each step
       - "Get Started" button that calls completeOnboarding action
       - On success, redirect to /dashboard

    4. Create `src/app/(onboarding)/layout.tsx`:
       - Server component
       - Centered layout with max-w-lg container
       - Glass card effect
       - Progress indicator (Step 1 of 2, Step 2 of 2)
       - Get current path to determine step

    5. Create `src/app/(onboarding)/onboarding/page.tsx`:
       - Server component
       - Get user from server Supabase client
       - If no user, redirect to /login
       - Render PortraitUpload with userId
       - On complete, redirect to /welcome
       - Page title: "Upload Your Portrait"
       - Subtitle: "This image will be used in your generated thumbnails"

    6. Create `src/app/(onboarding)/welcome/page.tsx`:
       - Server component
       - Render WelcomeTutorial
       - Page title: "Welcome to YouTube Thumbnail Factory"
  </action>
  <verify>
    Visit /onboarding - should show portrait upload UI
    TypeScript: `npx tsc --noEmit` passes
    Drag-drop zone should be visible with proper styling
  </verify>
  <done>Onboarding pages and components created with portrait upload and welcome tutorial</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard shell with sidebar and empty state</name>
  <files>
    src/app/(dashboard)/layout.tsx
    src/app/(dashboard)/dashboard/page.tsx
    src/components/dashboard/sidebar.tsx
    src/components/dashboard/user-nav.tsx
  </files>
  <action>
    1. Create `src/components/dashboard/sidebar.tsx` ("use client"):
       - Logo at top
       - Navigation links:
         - Dashboard (LayoutDashboard icon)
         - Generate (Sparkles icon) - disabled state for now
         - Gallery (Image icon) - disabled state for now
         - Portraits (User icon) - disabled state for now
         - Settings (Settings icon) - disabled state for now
       - Use active state styling (highlight current page)
       - Glass effect background
       - Collapsed state on mobile (hamburger menu)

    2. Create `src/components/dashboard/user-nav.tsx` ("use client"):
       - Get user info from props
       - Display user avatar (or initials if no avatar)
       - Display user name/email
       - Dropdown with:
         - Settings link
         - Sign out button (calls signOut action)
       - Use shadcn/ui DropdownMenu

    3. Create `src/app/(dashboard)/layout.tsx`:
       - Server component
       - Get user from server Supabase client
       - Get profile from database (for avatar_url)
       - Two-column layout: sidebar (fixed left) + main content
       - Header bar with UserNav on right
       - Main content area with padding
       - Responsive: sidebar hidden on mobile, hamburger menu instead

    4. Create `src/app/(dashboard)/dashboard/page.tsx`:
       - Server component
       - Get user and profile from Supabase
       - Display welcome message with user's name
       - Empty state for generations:
         - Icon (Sparkles)
         - "No thumbnails yet"
         - "Generate your first thumbnails to see them here"
         - CTA button: "Generate Thumbnails" (links to /generate - disabled for now)
       - Quick stats cards (all showing 0 for now):
         - Total generations
         - This month's usage
         - Portraits uploaded
  </action>
  <verify>
    After logging in and completing onboarding, visit /dashboard
    Should see sidebar navigation and empty state
    UserNav should show user info and sign out option
    TypeScript: `npx tsc --noEmit` passes
  </verify>
  <done>Dashboard layout with sidebar, user nav, and empty state created</done>
</task>

<task type="auto">
  <name>Task 3: Update middleware for onboarding enforcement</name>
  <files>
    src/middleware.ts
  </files>
  <action>
    Update `src/middleware.ts` to enforce onboarding:

    1. After checking user authentication, add onboarding check:

    ```typescript
    // Check onboarding status for non-onboarding routes
    if (!ONBOARDING_ROUTES.some(route => pathname.startsWith(route))) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarding_completed')
        .eq('id', user.id)
        .single()

      if (!profile?.onboarding_completed) {
        return NextResponse.redirect(new URL('/onboarding', request.url))
      }
    }

    // Redirect completed users away from onboarding pages
    if (ONBOARDING_ROUTES.some(route => pathname.startsWith(route))) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarding_completed')
        .eq('id', user.id)
        .single()

      if (profile?.onboarding_completed) {
        return NextResponse.redirect(new URL('/dashboard', request.url))
      }
    }
    ```

    2. Ensure the complete flow:
       - Unauthenticated users -> /login
       - Authenticated users with incomplete onboarding -> /onboarding
       - Authenticated users with complete onboarding -> dashboard (or their requested page)
       - Users who completed onboarding trying to access /onboarding -> /dashboard

    3. Handle edge case: profile not found (shouldn't happen due to trigger, but be safe)
       - If profile query fails, allow access (let page handle error)
  </action>
  <verify>
    Create new account via signup
    After email verification, should be redirected to /onboarding
    Complete portrait upload and welcome tutorial
    Should be redirected to /dashboard
    Trying to visit /onboarding again should redirect to /dashboard
  </verify>
  <done>Middleware enforces onboarding for new users, prevents re-access after completion</done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. New user flow: signup -> email verify -> /onboarding -> portrait upload -> /welcome -> /dashboard
3. Completed user cannot access /onboarding (redirects to /dashboard)
4. Dashboard shows empty state with appropriate messaging
5. Sidebar navigation renders with correct active states
6. UserNav shows user info and sign out works
7. `npm run build` completes successfully
</verification>

<success_criteria>
- Portrait upload accepts drag-drop and click-to-select
- Portrait upload validates file type (images only) and size (max 5MB)
- Portrait uploads to Supabase Storage in user folder
- Welcome tutorial explains the 3-step workflow
- Completing onboarding sets profile.onboarding_completed = true
- Middleware redirects incomplete users to /onboarding
- Middleware redirects completed users away from /onboarding
- Dashboard has sidebar with navigation links
- Dashboard shows empty state when no generations exist
- UserNav displays user info and allows sign out
- All pages use consistent dark theme with glass effects
</success_criteria>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication and onboarding flow</what-built>
  <how-to-verify>
    1. Visit http://localhost:3000 - should redirect to /login
    2. Click "Create account" and fill signup form
    3. Check email for verification link (may need to check Supabase dashboard for local dev)
    4. Click verification link - should land on /onboarding
    5. Upload a portrait image (drag or click)
    6. See welcome tutorial page, click "Get Started"
    7. Land on /dashboard with empty state
    8. Click user menu in top-right, click "Sign out"
    9. Should return to /login
    10. Log back in with credentials - should go directly to /dashboard (not onboarding)

    Expected: Full auth flow works, onboarding only shows once, dark theme consistent throughout
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</checkpoint>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
