---
phase: 01-foundation-auth
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/app/(auth)/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/signup/page.tsx
  - src/app/(auth)/forgot-password/page.tsx
  - src/app/(auth)/reset-password/page.tsx
  - src/app/auth/callback/route.ts
  - src/actions/auth.ts
  - src/lib/validations/auth.ts
  - src/components/auth/login-form.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/forgot-password-form.tsx
  - src/components/auth/reset-password-form.tsx
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "User can create account with email/password"
    - "User receives verification email after signup"
    - "User can log in with valid credentials"
    - "User can request password reset email"
    - "User can set new password via reset link"
    - "Unauthenticated users are redirected to login"
    - "Session persists across browser refresh"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page"
      contains: "LoginForm"
    - path: "src/app/(auth)/signup/page.tsx"
      provides: "Signup page"
      contains: "SignupForm"
    - path: "src/actions/auth.ts"
      provides: "Auth server actions"
      exports: ["signIn", "signUp", "signOut", "forgotPassword", "resetPassword"]
    - path: "src/middleware.ts"
      provides: "Route protection and session refresh"
      contains: "updateSession"
    - path: "src/app/auth/callback/route.ts"
      provides: "Auth callback handler"
      contains: "exchangeCodeForSession"
  key_links:
    - from: "src/components/auth/login-form.tsx"
      to: "src/actions/auth.ts"
      via: "signIn server action call"
      pattern: "signIn"
    - from: "src/middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "updateSession import"
      pattern: "import.*updateSession"
    - from: "src/app/auth/callback/route.ts"
      to: "supabase.auth.exchangeCodeForSession"
      via: "OAuth/magic link callback"
      pattern: "exchangeCodeForSession"
---

<objective>
Build complete authentication flow with login, signup, password reset, and session management using Supabase Auth.

Purpose: Enable users to create accounts, log in, and maintain sessions across the app.
Output: Working auth pages with forms, server actions, route protection middleware, and email verification flow.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth validation schemas and server actions</name>
  <files>
    src/lib/validations/auth.ts
    src/actions/auth.ts
  </files>
  <action>
    1. Create `src/lib/validations/auth.ts`:
       - Define Zod schemas for:
         - loginSchema: email (valid email), password (min 8 chars)
         - signupSchema: email (valid email), password (min 8 chars), fullName (min 2 chars)
         - forgotPasswordSchema: email (valid email)
         - resetPasswordSchema: password (min 8 chars), confirmPassword (must match)
       - Export type inferences for each schema

    2. Create `src/actions/auth.ts` with "use server" directive:

       a) `signIn(formData: FormData)`:
          - Parse email/password from formData
          - Create server Supabase client
          - Call supabase.auth.signInWithPassword()
          - On error, return { error: message }
          - On success, redirect to '/dashboard'

       b) `signUp(formData: FormData)`:
          - Parse email/password/fullName from formData
          - Create server Supabase client
          - Call supabase.auth.signUp() with:
            - email, password
            - options.data: { full_name: fullName }
            - options.emailRedirectTo: `${NEXT_PUBLIC_APP_URL}/auth/callback`
          - On error, return { error: message }
          - On success, redirect to '/login?message=Check your email to confirm your account'

       c) `signOut()`:
          - Create server Supabase client
          - Call supabase.auth.signOut()
          - Redirect to '/login'

       d) `forgotPassword(email: string)`:
          - Create server Supabase client
          - Call supabase.auth.resetPasswordForEmail() with:
            - redirectTo: `${NEXT_PUBLIC_APP_URL}/auth/callback?type=recovery`
          - Return { success: true } or { error: message }

       e) `resetPassword(password: string)`:
          - Create server Supabase client
          - Call supabase.auth.updateUser({ password })
          - On success, redirect to '/login?message=Password updated successfully'
          - On error, return { error: message }
  </action>
  <verify>
    TypeScript: `npx tsc --noEmit` passes
    Files exist: ls src/actions/auth.ts src/lib/validations/auth.ts
  </verify>
  <done>Validation schemas defined, all 5 auth server actions implemented</done>
</task>

<task type="auto">
  <name>Task 2: Create auth pages and form components</name>
  <files>
    src/app/(auth)/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/signup/page.tsx
    src/app/(auth)/forgot-password/page.tsx
    src/app/(auth)/reset-password/page.tsx
    src/components/auth/login-form.tsx
    src/components/auth/signup-form.tsx
    src/components/auth/forgot-password-form.tsx
    src/components/auth/reset-password-form.tsx
    src/app/auth/callback/route.ts
  </files>
  <action>
    1. Create `src/app/(auth)/layout.tsx`:
       - Centered layout with max-w-md container
       - Glass card effect background
       - App logo/title at top
       - Children rendered inside

    2. Create form components (all "use client"):

       a) `src/components/auth/login-form.tsx`:
          - Use react-hook-form with zodResolver(loginSchema)
          - Email and password inputs using shadcn/ui Input
          - Submit button with loading state (Loader2 icon when loading)
          - Call signIn server action on submit
          - Show toast on error using sonner
          - Link to signup and forgot-password pages

       b) `src/components/auth/signup-form.tsx`:
          - Fields: fullName, email, password
          - Call signUp server action
          - Link to login page
          - Same loading/error pattern

       c) `src/components/auth/forgot-password-form.tsx`:
          - Email field only
          - Call forgotPassword action
          - Show success message when email sent
          - Link back to login

       d) `src/components/auth/reset-password-form.tsx`:
          - Password and confirmPassword fields
          - Validate passwords match
          - Call resetPassword action

    3. Create page files:

       a) `src/app/(auth)/login/page.tsx`:
          - Render LoginForm
          - Show message from URL params (e.g., ?message=Check your email)
          - Page title: "Sign In"

       b) `src/app/(auth)/signup/page.tsx`:
          - Render SignupForm
          - Page title: "Create Account"

       c) `src/app/(auth)/forgot-password/page.tsx`:
          - Render ForgotPasswordForm
          - Page title: "Reset Password"

       d) `src/app/(auth)/reset-password/page.tsx`:
          - Render ResetPasswordForm
          - Page title: "Set New Password"

    4. Create `src/app/auth/callback/route.ts`:
       - GET handler for OAuth and email link callbacks
       - Extract 'code' and 'type' from searchParams
       - If code exists, call supabase.auth.exchangeCodeForSession(code)
       - If type === 'recovery', redirect to '/reset-password'
       - Otherwise redirect to '/dashboard'
       - On error, redirect to '/login?error=auth_callback_error'
  </action>
  <verify>
    Visit /login - form should render
    Visit /signup - form should render
    Visit /forgot-password - form should render
    TypeScript: `npx tsc --noEmit` passes
  </verify>
  <done>All 4 auth pages created with forms, callback route handles email verification and password reset links</done>
</task>

<task type="auto">
  <name>Task 3: Create middleware for route protection and session refresh</name>
  <files>
    src/middleware.ts
  </files>
  <action>
    Create `src/middleware.ts`:

    1. Define route arrays:
       - PUBLIC_ROUTES = ['/login', '/signup', '/forgot-password', '/reset-password', '/auth/callback']
       - ONBOARDING_ROUTES = ['/onboarding', '/welcome']

    2. Export async middleware function:

       a) Call updateSession(request) from lib/supabase/middleware

       b) Get pathname from request.nextUrl.pathname

       c) Handle public routes:
          - If path starts with any PUBLIC_ROUTE, allow through
          - But if user is logged in, redirect to '/dashboard'

       d) Handle protected routes (everything else):
          - If no user, redirect to '/login' with redirectTo param

       e) For now, skip onboarding check (will add in Plan 04)

       f) Return supabaseResponse

    3. Export config with matcher:
       ```typescript
       export const config = {
         matcher: [
           '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
         ],
       }
       ```

    Note: Use getUser() not getSession() for security (validates JWT signature).
  </action>
  <verify>
    Start dev server: `npm run dev`
    Visit /dashboard without logging in - should redirect to /login
    Auth pages (/login, /signup) should be accessible without auth
    TypeScript: `npx tsc --noEmit` passes
  </verify>
  <done>Middleware protects routes, refreshes sessions, redirects unauthenticated users to login</done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `/login` page renders with email/password form
3. `/signup` page renders with name/email/password form
4. `/forgot-password` page renders with email form
5. Visiting `/dashboard` without auth redirects to `/login`
6. `npm run build` completes successfully
</verification>

<success_criteria>
- Login form validates email format and password length
- Signup form creates account and sends verification email
- Forgot password form sends reset email
- Reset password form updates password
- Auth callback handles email verification and password reset links
- Middleware protects all routes except public auth pages
- Session refresh happens on every request via middleware
- All forms show loading states during submission
- Errors display via toast notifications
- Forms use react-hook-form with Zod validation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
