---
phase: 03-generation-gallery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - supabase/migrations/004_generations.sql
  - src/types/database.ts
  - src/components/ui/progress.tsx
  - src/components/ui/tabs.tsx
  - src/components/ui/tooltip.tsx
  - src/components/ui/dropdown-menu.tsx
  - src/components/ui/select.tsx
autonomous: true

must_haves:
  truths:
    - "generations and thumbnails tables exist in database"
    - "Database types are available for TypeScript usage"
    - "Required shadcn/ui components are installed"
  artifacts:
    - path: "supabase/migrations/004_generations.sql"
      provides: "generations and thumbnails tables with RLS"
      contains: "CREATE TABLE generations"
    - path: "src/types/database.ts"
      provides: "TypeScript types for new tables"
      contains: "generations"
    - path: "src/components/ui/progress.tsx"
      provides: "Progress bar component"
  key_links:
    - from: "src/types/database.ts"
      to: "supabase/migrations/004_generations.sql"
      via: "Type definitions match table schema"
---

<objective>
Set up database schema for thumbnail generations and install required dependencies.

Purpose: Establish the data layer foundation that all other Phase 3 features will build upon. Without the generations and thumbnails tables, no other feature can function.

Output: Database migration file, updated TypeScript types, and all required npm/shadcn dependencies installed.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-generation-gallery/03-RESEARCH.md

# Existing patterns to follow
@src/lib/supabase/server.ts
@supabase/migrations/003_portraits.sql
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and shadcn components</name>
  <files>package.json, package-lock.json, src/components/ui/*.tsx</files>
  <action>
Install npm dependencies:
```bash
npm install jszip file-saver
npm install -D @types/file-saver
```

Install shadcn/ui components:
```bash
npx shadcn@latest add progress tabs tooltip dropdown-menu select
```

These are required for:
- jszip + file-saver: Batch download of thumbnails as ZIP
- progress: Generation progress bar during 3-7 min processing
- tabs: Gallery view organization (current/history)
- tooltip: Action button hints
- dropdown-menu: Generation actions menu
- select: Portrait selection in generation form
  </action>
  <verify>
Run `npm ls jszip file-saver` shows versions installed.
Files exist: src/components/ui/progress.tsx, tabs.tsx, tooltip.tsx, dropdown-menu.tsx, select.tsx
  </verify>
  <done>All Phase 3 dependencies installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create generations database migration</name>
  <files>supabase/migrations/004_generations.sql</files>
  <action>
Create migration file with two tables following the schema from 03-RESEARCH.md:

**generations table:**
- id (UUID, PK)
- user_id (UUID, FK to auth.users, ON DELETE CASCADE)
- portrait_id (UUID, FK to portraits, ON DELETE SET NULL)
- portrait_url (TEXT NOT NULL) - Snapshot at generation time
- keywords (TEXT NOT NULL)
- background_count (INTEGER NOT NULL)
- status (TEXT NOT NULL DEFAULT 'pending') - pending/processing/completed/failed/partial
- progress (INTEGER DEFAULT 0, CHECK 0-100)
- current_step (TEXT) - Human-readable step description
- thumbnail_count (INTEGER DEFAULT 0)
- error_message (TEXT)
- created_at, started_at, completed_at (TIMESTAMPTZ)
- credits_used (INTEGER DEFAULT 1)

**thumbnails table:**
- id (UUID, PK)
- generation_id (UUID, FK to generations, ON DELETE CASCADE)
- storage_path (TEXT NOT NULL)
- public_url (TEXT NOT NULL)
- prompt (TEXT)
- prompt_index (INTEGER)
- background_index (INTEGER)
- kie_task_id (TEXT)
- status (TEXT DEFAULT 'success') - success/failed
- error_message (TEXT)
- created_at (TIMESTAMPTZ)

**RLS Policies:**
- Users can SELECT own generations
- Users can INSERT own generations
- Service role can UPDATE generations (for webhook callback)
- Users can SELECT thumbnails through their generations
- Service role can INSERT thumbnails

**Indexes:**
- generations(user_id)
- generations(status)
- thumbnails(generation_id)

**Realtime:**
- Enable REPLICA IDENTITY FULL on generations for Realtime subscriptions

**Trigger:**
- Reuse update_updated_at() function from prior migrations
  </action>
  <verify>
File exists at supabase/migrations/004_generations.sql.
SQL syntax valid: `npx supabase db lint --file supabase/migrations/004_generations.sql` or manual review.
  </verify>
  <done>Migration file ready to be run in Supabase SQL Editor</done>
</task>

<task type="auto">
  <name>Task 3: Update TypeScript database types</name>
  <files>src/types/database.ts</files>
  <action>
Add TypeScript interfaces for the new tables to src/types/database.ts.

Follow the existing pattern from profiles and portraits types.

Add to Database interface:
```typescript
generations: {
  Row: {
    id: string
    user_id: string
    portrait_id: string | null
    portrait_url: string
    keywords: string
    background_count: number
    status: 'pending' | 'processing' | 'completed' | 'failed' | 'partial'
    progress: number
    current_step: string | null
    thumbnail_count: number
    error_message: string | null
    created_at: string
    started_at: string | null
    completed_at: string | null
    credits_used: number
  }
  Insert: { ... }  // Same but optional fields marked optional
  Update: { ... }  // All fields optional
}

thumbnails: {
  Row: {
    id: string
    generation_id: string
    storage_path: string
    public_url: string
    prompt: string | null
    prompt_index: number | null
    background_index: number | null
    kie_task_id: string | null
    status: 'success' | 'failed'
    error_message: string | null
    created_at: string
  }
  Insert: { ... }
  Update: { ... }
}
```
  </action>
  <verify>
TypeScript compiles without errors: `cd src && npx tsc --noEmit`
Types are importable: can reference Database['public']['Tables']['generations']['Row']
  </verify>
  <done>TypeScript types available for generations and thumbnails tables</done>
</task>

</tasks>

<verification>
1. `npm ls jszip file-saver` shows both packages installed
2. shadcn components exist in src/components/ui/
3. Migration file has valid SQL (reviewed manually or lint passes)
4. TypeScript compiles with new types
5. All new types match migration schema exactly
</verification>

<success_criteria>
- [ ] jszip and file-saver packages installed
- [ ] @types/file-saver dev dependency installed
- [ ] progress, tabs, tooltip, dropdown-menu, select shadcn components installed
- [ ] 004_generations.sql migration file created with generations + thumbnails tables
- [ ] RLS policies defined for user access + service role updates
- [ ] Realtime enabled on generations table
- [ ] database.ts types updated with Generation and Thumbnail interfaces
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-generation-gallery/03-01-SUMMARY.md`
</output>
