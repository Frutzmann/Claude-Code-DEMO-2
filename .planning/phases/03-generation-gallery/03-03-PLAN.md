---
phase: 03-generation-gallery
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/hooks/use-generation-status.ts
  - src/components/generation/generation-form.tsx
  - src/components/generation/generation-status.tsx
  - src/components/generation/background-upload.tsx
  - src/components/generation/portrait-selector.tsx
  - src/app/(dashboard)/generate/page.tsx
  - src/app/(dashboard)/generate/client.tsx
  - src/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can select a portrait from their library"
    - "User can upload up to 7 background images"
    - "User can enter keywords for generation"
    - "System shows quota usage before generation"
    - "User sees real-time status updates during generation"
    - "Admin sees unlimited badge instead of quota"
  artifacts:
    - path: "src/app/(dashboard)/generate/page.tsx"
      provides: "Generation form page"
    - path: "src/components/generation/generation-form.tsx"
      provides: "Form with portrait selector, background upload, keywords"
    - path: "src/components/generation/generation-status.tsx"
      provides: "Real-time status display with progress bar"
    - path: "src/hooks/use-generation-status.ts"
      provides: "Supabase Realtime subscription hook"
      exports: ["useGenerationStatus"]
  key_links:
    - from: "src/hooks/use-generation-status.ts"
      to: "supabase.channel"
      via: "Realtime subscription"
      pattern: "postgres_changes.*generations"
    - from: "src/components/generation/generation-form.tsx"
      to: "src/actions/generations.ts"
      via: "createGeneration call"
      pattern: "createGeneration"
    - from: "src/app/(dashboard)/generate/page.tsx"
      to: "/gallery"
      via: "Redirect on completion"
---

<objective>
Build the generation form UI with real-time status updates using Supabase Realtime.

Purpose: This is the primary user-facing feature - the form that kicks off thumbnail generation. Users need clear feedback during the 3-7 minute generation process.

Output: Generation form page with portrait selector, background upload, keywords input, quota display, and real-time progress tracking.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-generation-gallery/03-RESEARCH.md
@.planning/phases/03-generation-gallery/03-02-SUMMARY.md

# Existing patterns
@src/app/(dashboard)/portraits/page.tsx
@src/app/(dashboard)/portraits/client.tsx
@src/components/portraits/portrait-upload-dialog.tsx
@src/lib/supabase/client.ts
@src/actions/portraits.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Realtime hook and generation components</name>
  <files>src/hooks/use-generation-status.ts, src/components/generation/portrait-selector.tsx, src/components/generation/background-upload.tsx</files>
  <action>
**Create src/hooks/use-generation-status.ts:**

Hook that:
1. Takes generationId, onComplete callback, onError callback
2. Fetches initial generation state
3. Subscribes to postgres_changes on generations table (filter by id)
4. Returns { generation, isLoading }
5. Cleans up subscription on unmount
6. Calls onComplete when status === "completed"
7. Calls onError when status === "failed"

Follow pattern from 03-RESEARCH.md:
```typescript
const channel = supabase
  .channel(`generation-${generationId}`)
  .on("postgres_changes", {
    event: "UPDATE",
    schema: "public",
    table: "generations",
    filter: `id=eq.${generationId}`,
  }, (payload) => { ... })
  .subscribe()
```

**Create src/components/generation/portrait-selector.tsx:**

Component using shadcn Select that:
1. Receives portraits array as prop
2. Shows portrait label and (Active) badge for is_active portrait
3. Has small thumbnail preview in each option (optional enhancement)
4. Returns selected portrait ID via onChange

**Create src/components/generation/background-upload.tsx:**

Multi-file upload component that:
1. Accepts up to 7 images (MAX_BACKGROUNDS from validations)
2. Shows grid preview of selected files
3. Allows removing individual files
4. Validates file type (ALLOWED_IMAGE_TYPES) and size (MAX_FILE_SIZE)
5. Returns File[] via onFilesChange callback
6. Shows "+ Add" button when under 7 files
7. Drag-and-drop support (follow portrait-upload-dialog.tsx pattern)
  </action>
  <verify>
Files exist and TypeScript compiles.
Hook properly subscribes to Realtime channel.
Components accept correct props.
  </verify>
  <done>Realtime hook and form sub-components ready for integration</done>
</task>

<task type="auto">
  <name>Task 2: Create generation form and status components</name>
  <files>src/components/generation/generation-form.tsx, src/components/generation/generation-status.tsx</files>
  <action>
**Create src/components/generation/generation-form.tsx:**

Form component that:
1. Receives portraits, isAdmin, quota (used/limit or null) as props
2. Receives onGenerationStarted(generationId) callback
3. Uses react-hook-form with zod resolver
4. Has portrait selector (default to active portrait)
5. Has background upload component (tracks File[] in state)
6. Has keywords input (textarea or input)
7. Shows quota display:
   - Admin: "Admin - Unlimited generations"
   - Regular: "X / Y generations this month"
   - Exceeded: Red text "Quota exceeded. Upgrade to continue."
8. Submit button disabled when quota exceeded or no backgrounds
9. On submit:
   - Calls createBackgroundUploadUrls(files.length)
   - Uploads files to signed URLs
   - Calls createGeneration with portrait ID, keywords, and storage paths
   - Calls onGenerationStarted with returned generation ID

**Create src/components/generation/generation-status.tsx:**

Status display component that:
1. Receives generationId as prop
2. Uses useGenerationStatus hook
3. Shows different UI based on status:
   - pending: Clock icon, "Queued"
   - processing: Animated Loader2 icon, Progress bar, current_step text
   - completed: CheckCircle icon, green, thumbnail count
   - failed: XCircle icon, red, error message
   - partial: CheckCircle icon, yellow, partial success message
4. Shows generation metadata: keywords, background count
5. On complete: uses router.push to redirect to /gallery/[id]
  </action>
  <verify>
Files exist and TypeScript compiles.
Form integrates all sub-components.
Status component uses Realtime hook correctly.
  </verify>
  <done>Generation form and status components ready for page integration</done>
</task>

<task type="auto">
  <name>Task 3: Create generate page and enable sidebar link</name>
  <files>src/app/(dashboard)/generate/page.tsx, src/app/(dashboard)/generate/client.tsx, src/components/dashboard/sidebar.tsx</files>
  <action>
**Create src/app/(dashboard)/generate/page.tsx:**

Server component that:
1. Gets authenticated user
2. Fetches user's portraits (for selector)
3. Calculates quota (count generations this month, compare to limit)
4. Checks isAdmin status
5. Renders GenerateClient with data

Follow pattern from portraits/page.tsx:
```typescript
export default async function GeneratePage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  // Fetch portraits, calculate quota
  return <GenerateClient portraits={...} isAdmin={...} quota={...} />
}
```

**Create src/app/(dashboard)/generate/client.tsx:**

Client component that:
1. Manages state: currentGenerationId (null or string)
2. If no currentGenerationId: shows GenerationForm
3. If currentGenerationId: shows GenerationStatus
4. On generation started: set currentGenerationId
5. Allows "New Generation" button to reset and start over

Page layout: Card with title "Generate Thumbnails" and description explaining the process.

**Update src/components/dashboard/sidebar.tsx:**

Enable the "Generate" link (remove disabled state and "Soon" badge).
Keep Gallery disabled for now (Plan 04 will enable it).
  </action>
  <verify>
Page loads at /generate without errors.
Generate link in sidebar is enabled and navigates to /generate.
Form displays with portrait selector, background upload, keywords input.
Quota shows correctly for user (or unlimited for admin).
  </verify>
  <done>Generation page accessible and functional (pending n8n integration for full flow)</done>
</task>

</tasks>

<verification>
1. Navigate to /generate - page loads with form
2. Portrait selector shows user's portraits with active badge
3. Can add up to 7 background images
4. Keywords input accepts text
5. Quota displays correctly (or unlimited for admin)
6. Submit button disabled when appropriate
7. Sidebar "Generate" link is enabled
8. TypeScript compiles without errors
</verification>

<success_criteria>
- [ ] useGenerationStatus hook subscribes to Realtime and cleans up
- [ ] PortraitSelector component shows portraits with active indicator
- [ ] BackgroundUpload accepts up to 7 images with previews
- [ ] GenerationForm validates inputs and shows quota
- [ ] GenerationStatus shows progress and redirects on completion
- [ ] /generate page fetches user data server-side
- [ ] Generate link enabled in sidebar
- [ ] Form submission triggers generation flow
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-generation-gallery/03-03-SUMMARY.md`
</output>
