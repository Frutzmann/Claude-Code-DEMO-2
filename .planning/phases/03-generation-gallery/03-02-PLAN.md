---
phase: 03-generation-gallery
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/n8n/client.ts
  - src/lib/validations/generations.ts
  - src/actions/generations.ts
  - src/app/api/webhooks/n8n-callback/route.ts
  - src/middleware.ts
autonomous: true

user_setup:
  - service: n8n
    why: "Webhook URL for triggering thumbnail generation"
    env_vars:
      - name: N8N_WEBHOOK_URL
        source: "n8n workflow webhook URL (from existing workflow)"
      - name: N8N_WEBHOOK_SECRET
        source: "Optional: shared secret for HMAC verification"

must_haves:
  truths:
    - "Server action can create a generation record and trigger n8n"
    - "n8n callback route can receive results and update database"
    - "Webhook route is accessible without auth (excluded from middleware)"
  artifacts:
    - path: "src/actions/generations.ts"
      provides: "createGeneration server action"
      exports: ["createGeneration"]
    - path: "src/app/api/webhooks/n8n-callback/route.ts"
      provides: "POST handler for n8n callback"
      exports: ["POST"]
    - path: "src/lib/n8n/client.ts"
      provides: "n8n webhook trigger utility"
      exports: ["triggerN8nWorkflow"]
  key_links:
    - from: "src/actions/generations.ts"
      to: "src/lib/n8n/client.ts"
      via: "triggerN8nWorkflow call"
      pattern: "triggerN8nWorkflow"
    - from: "src/app/api/webhooks/n8n-callback/route.ts"
      to: "supabase generations table"
      via: "Service role update"
      pattern: "supabase.*from.*generations.*update"
---

<objective>
Build the backend infrastructure for thumbnail generation: server actions, n8n trigger client, and callback webhook.

Purpose: This is the core backend that connects the frontend form to the n8n workflow. The callback webhook allows n8n to deliver results asynchronously after the 3-7 minute generation process.

Output: Server action for creating generations, n8n webhook trigger utility, and API route for receiving n8n callbacks.
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-generation-gallery/03-RESEARCH.md
@.planning/phases/03-generation-gallery/03-01-SUMMARY.md

# Existing patterns
@src/actions/portraits.ts
@src/lib/supabase/server.ts
@src/lib/admin.ts
@src/middleware.ts
@src/types/database.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n client and validation schemas</name>
  <files>src/lib/n8n/client.ts, src/lib/validations/generations.ts</files>
  <action>
**Create src/lib/n8n/client.ts:**

```typescript
interface TriggerPayload {
  generation_id: string
  portrait_url: string
  background_urls: string[]
  keywords: string
  callback_url: string
}

export async function triggerN8nWorkflow(payload: TriggerPayload) {
  const webhookUrl = process.env.N8N_WEBHOOK_URL
  if (!webhookUrl) {
    throw new Error("N8N_WEBHOOK_URL not configured")
  }

  const response = await fetch(webhookUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      generation_id: payload.generation_id,
      Keywords: payload.keywords,  // Match existing n8n workflow format
      portrait_url: payload.portrait_url,
      "Background Images": payload.background_urls.map((url, i) => ({
        url,
        index: i,
      })),
      callback_url: payload.callback_url,
    }),
  })

  if (!response.ok) {
    const text = await response.text()
    throw new Error(`n8n trigger failed: ${response.status} - ${text}`)
  }

  return response.json()
}
```

**Create src/lib/validations/generations.ts:**

```typescript
import { z } from "zod"

export const createGenerationSchema = z.object({
  portraitId: z.string().uuid("Invalid portrait ID"),
  keywords: z.string().min(3, "Keywords must be at least 3 characters").max(500, "Keywords too long"),
})

// For validating file uploads (checked separately from zod)
export const MAX_BACKGROUNDS = 7
export const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB
export const ALLOWED_IMAGE_TYPES = ["image/jpeg", "image/png", "image/webp"]
```
  </action>
  <verify>
Files exist and TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>n8n client utility and validation schemas ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Create generation server action</name>
  <files>src/actions/generations.ts</files>
  <action>
Create server action that:
1. Authenticates user
2. Validates inputs (portrait ID, keywords, background files)
3. Checks quota (unless admin)
4. Creates signed upload URLs for backgrounds
5. Creates generation record in database
6. Triggers n8n workflow with callback URL
7. Returns generation ID for client to subscribe to

**Key implementation details:**
- Use `isAdmin()` from src/lib/admin.ts for quota bypass
- Quota check: count generations this month (simplified - full quota from billing in Phase 4)
- For now, use a placeholder quota of 5 generations/month for non-admin
- Background images: generate signed upload URLs, client will upload directly
- Callback URL: `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/n8n-callback`

**Actions to export:**
- `createBackgroundUploadUrls(count: number)` - Returns signed URLs for direct upload
- `createGeneration(formData: FormData)` - Main action that creates record and triggers n8n

Follow the auth check pattern from portraits.ts: check user first, validate, then operate.

Note: Background images are uploaded via signed URLs to bypass body size limits. The flow is:
1. Client calls createBackgroundUploadUrls(N)
2. Client uploads files directly to Supabase Storage using signed URLs
3. Client calls createGeneration with portrait ID, keywords, and storage paths
  </action>
  <verify>
File exists at src/actions/generations.ts.
TypeScript compiles without errors.
Exports createBackgroundUploadUrls and createGeneration functions.
  </verify>
  <done>Server actions handle generation creation with quota check and n8n trigger</done>
</task>

<task type="auto">
  <name>Task 3: Create n8n callback webhook route</name>
  <files>src/app/api/webhooks/n8n-callback/route.ts, src/middleware.ts</files>
  <action>
**Create src/app/api/webhooks/n8n-callback/route.ts:**

POST handler that:
1. Optionally verifies HMAC signature (if N8N_WEBHOOK_SECRET set)
2. Parses callback payload from n8n
3. Downloads thumbnail images from Kie.ai URLs
4. Uploads to Supabase Storage (thumbnails bucket)
5. Creates thumbnail records in database
6. Updates generation status to completed/failed/partial
7. Returns success response

Use service role client (not user client) since this is server-to-server.

**Payload structure from n8n:**
```typescript
interface N8nCallbackPayload {
  generation_id: string
  status: "completed" | "failed" | "partial"
  thumbnails?: Array<{
    image_url: string
    prompt: string
    prompt_index: number
    background_index: number
    kie_task_id: string
    status: "success" | "failed"
    error_message?: string
  }>
  error?: string
}
```

**Update src/middleware.ts:**
Add `/api/webhooks` to exclusion pattern so callback route is accessible without auth.

Update the matcher pattern OR add to PUBLIC_ROUTES:
```typescript
const PUBLIC_ROUTES = [
  "/login",
  "/signup",
  "/forgot-password",
  "/reset-password",
  "/auth/callback",
  "/api/webhooks",  // Add this
]
```

**Storage bucket note:**
The callback needs a 'thumbnails' bucket. Add a note in the summary that this bucket needs to be created (public, like portraits bucket).
  </action>
  <verify>
Route file exists at src/app/api/webhooks/n8n-callback/route.ts.
Middleware updated with /api/webhooks exclusion.
TypeScript compiles without errors.
Test: `curl -X POST http://localhost:3000/api/webhooks/n8n-callback -H "Content-Type: application/json" -d '{"generation_id":"test"}'` returns response (not 401/403).
  </verify>
  <done>Callback route receives n8n results and updates database</done>
</task>

</tasks>

<verification>
1. All files created and TypeScript compiles
2. n8n client properly formats payload for existing workflow
3. Server action validates inputs and checks quota
4. Callback route is accessible without authentication
5. Callback route uses service role for database operations
</verification>

<success_criteria>
- [ ] src/lib/n8n/client.ts exports triggerN8nWorkflow function
- [ ] src/lib/validations/generations.ts exports schemas and constants
- [ ] src/actions/generations.ts exports createBackgroundUploadUrls and createGeneration
- [ ] createGeneration validates inputs, checks quota, triggers n8n
- [ ] src/app/api/webhooks/n8n-callback/route.ts handles POST requests
- [ ] Callback downloads thumbnails to Supabase Storage
- [ ] Callback updates generation status and creates thumbnail records
- [ ] /api/webhooks excluded from auth middleware
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-generation-gallery/03-02-SUMMARY.md`

**User setup note:** Include in summary that user needs to:
1. Set N8N_WEBHOOK_URL environment variable
2. Optionally set N8N_WEBHOOK_SECRET for signature verification
3. Create 'thumbnails' storage bucket in Supabase (public)
4. Create 'backgrounds' storage bucket in Supabase (public)
5. Run the 004_generations.sql migration
</output>
