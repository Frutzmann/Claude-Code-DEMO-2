---
phase: 03-generation-gallery
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/(dashboard)/gallery/page.tsx
  - src/app/(dashboard)/gallery/client.tsx
  - src/app/(dashboard)/gallery/[id]/page.tsx
  - src/app/(dashboard)/gallery/[id]/client.tsx
  - src/components/generation/gallery-list.tsx
  - src/components/generation/thumbnail-grid.tsx
  - src/components/generation/download-button.tsx
  - src/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all past generations"
    - "User can see status, date, and thumbnail count for each generation"
    - "User can view all thumbnails from a specific generation"
    - "User can download individual thumbnails"
    - "User can download all thumbnails as a ZIP file"
    - "User can see which keywords and portrait were used"
  artifacts:
    - path: "src/app/(dashboard)/gallery/page.tsx"
      provides: "Gallery list page"
    - path: "src/app/(dashboard)/gallery/[id]/page.tsx"
      provides: "Generation detail page"
    - path: "src/components/generation/thumbnail-grid.tsx"
      provides: "Thumbnail display grid"
    - path: "src/components/generation/download-button.tsx"
      provides: "Individual and batch download functionality"
      exports: ["DownloadButton", "DownloadAllButton"]
  key_links:
    - from: "src/components/generation/download-button.tsx"
      to: "jszip/file-saver"
      via: "ZIP creation and download"
      pattern: "JSZip|saveAs"
    - from: "src/app/(dashboard)/gallery/[id]/page.tsx"
      to: "supabase.from.thumbnails"
      via: "Fetch thumbnails for generation"
      pattern: "from.*thumbnails.*select"
---

<objective>
Build the gallery pages for viewing past generations and downloading thumbnails.

Purpose: Users need to access their generated thumbnails after the generation completes. The gallery provides history of all generations and download functionality.

Output: Gallery list page, generation detail page with thumbnail grid, and download functionality (individual + batch ZIP).
</objective>

<execution_context>
@/Users/frutz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/frutz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-generation-gallery/03-RESEARCH.md
@.planning/phases/03-generation-gallery/03-02-SUMMARY.md

# Existing patterns
@src/app/(dashboard)/portraits/page.tsx
@src/app/(dashboard)/portraits/client.tsx
@src/components/portraits/portrait-grid.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gallery list components</name>
  <files>src/components/generation/gallery-list.tsx, src/app/(dashboard)/gallery/page.tsx, src/app/(dashboard)/gallery/client.tsx</files>
  <action>
**Create src/components/generation/gallery-list.tsx:**

List component that:
1. Receives generations array as prop
2. Shows empty state with link to /generate if no generations
3. For each generation, shows:
   - Keywords (truncated if long)
   - Thumbnail count and background count
   - Status badge (completed/failed/processing/pending)
   - Relative time (using date-fns formatDistanceToNow or similar)
   - Chevron to indicate clickable
4. Each item links to /gallery/[id]
5. Uses Card component for each item
6. Sorted by created_at descending (newest first)

**Create src/app/(dashboard)/gallery/page.tsx:**

Server component that:
1. Gets authenticated user
2. Fetches all user's generations ordered by created_at DESC
3. Renders GalleryClient with generations

```typescript
const { data: generations } = await supabase
  .from("generations")
  .select("*")
  .eq("user_id", user.id)
  .order("created_at", { ascending: false })
```

**Create src/app/(dashboard)/gallery/client.tsx:**

Simple client wrapper that:
1. Receives generations array
2. Shows page header "Your Generations"
3. Shows GalleryList component
4. Optional: Link to /generate for new generation
  </action>
  <verify>
Files exist and TypeScript compiles.
Page loads at /gallery.
Shows list of generations or empty state.
  </verify>
  <done>Gallery list page displays all past generations</done>
</task>

<task type="auto">
  <name>Task 2: Create generation detail page and thumbnail grid</name>
  <files>src/components/generation/thumbnail-grid.tsx, src/app/(dashboard)/gallery/[id]/page.tsx, src/app/(dashboard)/gallery/[id]/client.tsx</files>
  <action>
**Create src/components/generation/thumbnail-grid.tsx:**

Grid component that:
1. Receives thumbnails array as prop
2. Displays thumbnails in responsive grid (2 cols mobile, 3 md, 4 lg)
3. Each thumbnail shows:
   - Image (using next/image for optimization)
   - Hover overlay with download button
   - Prompt text below (truncated)
   - Background index indicator (optional)
4. Handles failed thumbnails (show error state)
5. Click on thumbnail could open larger preview (optional enhancement)

**Create src/app/(dashboard)/gallery/[id]/page.tsx:**

Server component that:
1. Gets authenticated user
2. Fetches generation by ID (validates user owns it via RLS)
3. Fetches all thumbnails for that generation
4. Returns 404 if generation not found
5. Renders GenerationDetailClient with data

```typescript
const { data: generation } = await supabase
  .from("generations")
  .select("*")
  .eq("id", params.id)
  .single()

const { data: thumbnails } = await supabase
  .from("thumbnails")
  .select("*")
  .eq("generation_id", params.id)
  .order("background_index", { ascending: true })
```

**Create src/app/(dashboard)/gallery/[id]/client.tsx:**

Client component that:
1. Receives generation and thumbnails as props
2. Shows generation metadata:
   - Keywords
   - Portrait used (show thumbnail if portrait_url available)
   - Background count
   - Status
   - Created date
3. Shows ThumbnailGrid with thumbnails
4. Shows download buttons (Task 3)
5. Back link to /gallery
  </action>
  <verify>
Files exist and TypeScript compiles.
Page loads at /gallery/[valid-uuid].
Shows generation metadata and thumbnail grid.
404 for invalid/non-owned generation ID.
  </verify>
  <done>Generation detail page displays thumbnails and metadata</done>
</task>

<task type="auto">
  <name>Task 3: Create download functionality and enable sidebar</name>
  <files>src/components/generation/download-button.tsx, src/components/dashboard/sidebar.tsx</files>
  <action>
**Create src/components/generation/download-button.tsx:**

Two components for download functionality:

**DownloadButton (single thumbnail):**
1. Receives public_url and filename as props
2. On click: fetch image, create blob, trigger download
3. Shows Download icon
4. Can be used as icon button on thumbnail hover

```typescript
const handleDownload = async () => {
  const response = await fetch(publicUrl)
  const blob = await response.blob()
  const url = URL.createObjectURL(blob)
  const a = document.createElement("a")
  a.href = url
  a.download = filename
  a.click()
  URL.revokeObjectURL(url)
}
```

**DownloadAllButton (batch ZIP):**
1. Receives thumbnails array and generationId as props
2. On click:
   - Show loading state "Creating ZIP..."
   - Fetch all thumbnail images
   - Create ZIP using JSZip
   - Name files: thumbnail_{prompt_index}_bg{background_index}.png
   - Save using file-saver: thumbnails-{generation_id_short}.zip
   - Show toast on success/error
3. Shows Download icon with "Download All" text
4. Disabled while downloading

Follow pattern from 03-RESEARCH.md for JSZip usage.

**Update src/components/dashboard/sidebar.tsx:**

Enable the "Gallery" link (remove disabled state and "Soon" badge).
Both Generate and Gallery should now be enabled.
  </action>
  <verify>
Files exist and TypeScript compiles.
DownloadButton triggers single file download.
DownloadAllButton creates and downloads ZIP file.
Gallery link in sidebar is enabled.
  </verify>
  <done>Download functionality complete; Gallery accessible from sidebar</done>
</task>

</tasks>

<verification>
1. /gallery shows list of generations or empty state
2. Clicking a generation navigates to /gallery/[id]
3. Detail page shows generation metadata and thumbnails
4. Individual download button downloads single image
5. "Download All" button creates ZIP with all thumbnails
6. Sidebar has both Generate and Gallery links enabled
7. TypeScript compiles without errors
</verification>

<success_criteria>
- [ ] GalleryList shows generations with status, date, counts
- [ ] Empty state shows when no generations exist
- [ ] /gallery/[id] shows generation detail with metadata
- [ ] ThumbnailGrid displays thumbnails in responsive grid
- [ ] Individual thumbnail download works
- [ ] Batch ZIP download works using JSZip + file-saver
- [ ] Gallery link enabled in sidebar
- [ ] TypeScript compiles without errors
- [ ] RLS prevents access to other users' generations
</success_criteria>

<output>
After completion, create `.planning/phases/03-generation-gallery/03-04-SUMMARY.md`
</output>
