# YouTube Thumbnail Factory - n8n Workflow

## Objectif
OnFormSubmission → Fetch Persistent Image (Airtable) → Agent IA (3-5 prompts) → HTTP Request (Upload Images to Kie using endpoint) → HTTP Request (Generate Tasks (async)) → Poll until complete → HTTP Request (Download images generated by Kie) → Store (Airtable)
**Champs requis :**
- `keywords` (string) : Mots-clés décrivant le sujet de la vidéo
- `background_images` (file upload, multiple) : Assets pour l'arrière-plan (screenshots workflow, etc.)

### 2. Fetch Persistent Image
**Source :** Table Airtable `persistent_images`
**Récupérer :** L'image de la tête (attachment) à utiliser dans toutes les miniatures

### 3. Agent IA - Générateur de Prompts
**Rôle :** Générer 3-5 prompts distincts basés sur le squelette ci-dessous, en variant :
- Photo Uploadée: tête à adapter selon le sentiment du champ lexical des mots clés
- Le texte principal (accroche)
- Le style d'arrière-plan
- Le mood général

**Squelette de prompt à adapter :**

```
ROLE: Designer miniatures YouTube, style tech/automatisation, rendu clean, glowy et futuriste.

TASK: Miniature YouTube 1280x720, format SPLIT SCREEN (avant/après).

PHOTO UPLOADÉE:
* Utiliser la photo 2 FOIS (split)
* GAUCHE : Détourer, expression fatiguée/épuisée, tête légèrement penchée, regard overwhelmed
* DROITE : Détourer, expression sereine/confiante, léger sourire, posture droite

ARRIÈRE-PLAN:
* GAUCHE : Fond chaotique avec [ÉLÉMENT CONTEXTUEL] floutés empilés, teinte rouge/orange (#FF6B6B) à 40%, effet "surcharge visuelle"
* DROITE : Fond clean avec [ASSET UPLOADÉ] flouté, teinte navy (#011638) à 60%, glow violet diffus (#9D4F9E)
* Séparation diagonale ou flèche centrale entre les deux zones

TEXTE PRINCIPAL:
* "[ACCROCHE GÉNÉRÉE]"
* CENTRE-BAS, très gros, blanc (#EEF0F2), glow violet intense (#9D4F9E)
* Flèche stylisée si transformation temporelle

ÉLÉMENTS ADDITIONNELS:
* Icône contextuelle côté gauche (rouge/orange)
* Icône contextuelle côté droit (vert)

COULEURS: #011638, #9D4F9E, #EEF0F2, #FF6B6B (chaos), #4CAF50 (check)

MOOD: [MOOD VARIÉ - transformation, soulagement, découverte, puissance, simplicité]
```

**Instructions pour l'agent :**
- Adapter `[ÉLÉMENT CONTEXTUEL]` selon les keywords (onglets, emails, fichiers Excel, notifications...)
- Générer des `[ACCROCHE GÉNÉRÉE]` variées (ex: "4H → 2 MIN", "STOP LE CHAOS", "1 CLIC = FINI", "AVANT J'ÉTAIS FOU"...)
- Varier les `[MOOD]` entre les prompts
- Chaque prompt doit être autonome et complet
- Output : JSON array de 3-5 prompts strings

### 4. Upload Images to Kie.ai
**Endpoint :** `POST https://kieai.redpandaai.co/api/file-base64-upload`
**Documentation:** `https://docs.kie.ai/market/google/pro-image-to-image`

**Headers :**
```
Authorization: Bearer [API_KEY]
Content-Type: application/json
```

**Body :**
```json
{
  "base64Data": "[IMAGE_BASE64]",
  "uploadPath": "images/base64",
  "fileName": "[UNIQUE_FILENAME].png"
}
```

**Images à uploader :**
- L'image persistante (tête)
- Chaque image d'arrière-plan uploadée via le formulaire

**Response :** `image_uri` à conserver pour l'étape suivante

### 5. Generate Image Tasks (Async)
**Endpoint :** `POST https://api.kie.ai/api/v1/jobs/createTask`

**Headers :**
```
Authorization: Bearer [API_KEY]
Content-Type: application/json
```

**Body :**
```json
{
  "model": "nano-banana-pro",
  "input": {
    "prompt": "[PROMPT_GÉNÉRÉ]",
    "image_input": [
      "[IMAGE_URI_TETE]",
      "[IMAGE_URI_BACKGROUND]"
    ],
    "output_format": "png",
    "resolution": "2K"
  }
}
```

**Response :** `data.taskId` à stocker pour le polling

**Note :** Créer une task pour CHAQUE prompt généré (3-5 tasks total)

### 6. Polling jusqu'à Completion
**Endpoint :** `GET https://api.kie.ai/api/v1/jobs/recordInfo?taskId=[TASK_ID]`

**Headers :**
```
Authorization: Bearer [API_KEY]
```

**Logique de polling :**
- Intervalle : 10 secondes entre chaque check
- Timeout : 5 minutes max par task
- Conditions d'arrêt : status `completed` ou `failed`
- Continuer jusqu'à ce que TOUTES les tasks soient terminées

**Response success :** URL(s) des images générées dans `data.output` ou similaire

### 7. Download & Store
**Actions :**
1. Télécharger chaque image générée via HTTP Request (GET sur l'URL)
2. Upload vers Airtable dans la table de destination
3. Lier à un record avec metadata (keywords utilisés, date, prompts)

## Configuration Requise

### Credentials n8n
- **Airtable API** : Pour lecture/écriture des images
- **Kie.ai API Key** : `Bearer [API_KEY]` pour tous les endpoints

### Tables Airtable
1. **persistent_images** : Contient l'image de tête (attachment field)
2. **generated_thumbnails** : Destination des miniatures générées
   - `images` (attachment)
   - `keywords` (text)
   - `prompts_used` (long text)
   - `created_at` (date)

## Gestion d'Erreurs
- Si upload Kie échoue : retry 2x avec délai exponentiel
- Si task échoue : logger le prompt qui a échoué, continuer avec les autres
- Si polling timeout : marquer comme failed, ne pas bloquer les autres tasks

## Notes Techniques
- Les images doivent être converties en base64 avant upload Kie
- Utiliser des noms de fichiers uniques (timestamp + uuid)
- Le polling doit être parallélisé si possible (ne pas attendre task 1 pour checker task 2)
- Stocker les taskIds dans un array pour tracker toutes les générations en cours